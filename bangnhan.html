<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Bảng Cửu Chương</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Baloo 2', cursive;
            touch-action: manipulation;
        }
        .game-container {
            perspective: 1000px;
        }
        .game-card {
            box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.1);
            border: 4px solid #fff;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .game-card.is-flipped {
            transform: rotateY(180deg);
        }
        .icon-face {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .btn-3d {
             box-shadow: 0 5px 0 rgba(0,0,0,0.2);
             transition: all 0.1s ease-in-out;
        }
        .btn-3d:active {
            transform: translateY(5px);
            box-shadow: 0 0px 0 rgba(0,0,0,0.2);
        }
        .btn-3d:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-amber-100 flex items-center justify-center min-h-screen p-4 overflow-hidden">

<div class="w-full max-w-sm mx-auto game-container">
    <div id="game-card" class="relative w-full h-[650px] game-card">
        <!-- Mặt trước: Menu chọn bảng cửu chương -->
        <div class="absolute w-full h-full p-6 text-center text-white bg-amber-400 rounded-2xl card-face">
            <h1 class="text-4xl font-bold mb-6" style="text-shadow: 2px 2px 0px rgba(0,0,0,0.1);">Bảng Cửu Chương</h1>
            <p class="mb-8 text-amber-800 font-semibold">Chọn một bảng để bắt đầu!</p>
            <div id="menu-grid" class="grid grid-cols-3 gap-4">
                <!-- Các nút từ 1-9 sẽ được tạo bởi JS -->
            </div>
        </div>

        <!-- Mặt sau: Giao diện game -->
        <div id="game-screen" class="absolute w-full h-full p-6 text-center text-white bg-sky-400 rounded-2xl card-face card-back">
            <button id="back-btn" class="absolute top-4 left-4 text-white bg-black/20 rounded-full w-10 h-10 flex items-center justify-center font-bold text-lg btn-3d">&larr;</button>
            <h1 id="game-title" class="text-4xl font-bold mb-4" style="text-shadow: 2px 2px 0px rgba(0,0,0,0.1);">Bảng nhân 7</h1>
            
            <!-- Bảng điểm -->
            <div class="flex justify-around items-center bg-white/30 rounded-lg p-2 mb-2">
                <div><span class="text-3xl font-bold text-green-300" id="correct-score">0</span><p class="text-xs">Đúng</p></div>
                <div><span class="text-3xl font-bold" id="question-counter">1</span><p class="text-xs">Câu</p></div>
                <div><span class="text-3xl font-bold text-red-300" id="incorrect-score">0</span><p class="text-xs">Sai</p></div>
            </div>

            <!-- Icon hoạt hình -->
            <div class="my-4 h-28 flex items-center justify-center">
                <div id="icon-container" class="icon-face">
                    <svg class="w-28 h-28" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="#FFD15C" stroke="#E6A500" stroke-width="4"/>
                        <circle cx="35" cy="45" r="8" fill="white"/><circle cx="35" cy="45" r="4" fill="black"/>
                        <circle cx="65" cy="45" r="8" fill="white"/><circle cx="65" cy="45" r="4" fill="black"/>
                        <path id="mouth" d="M 35 70 Q 50 80, 65 70" stroke="black" stroke-width="4" fill="none" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
            
            <!-- Phép toán -->
            <div class="mb-6 text-center">
                <div id="problem-text" class="text-6xl text-gray-800 font-bold bg-white rounded-lg p-4 shadow-inner">7 x 3 = ?</div>
            </div>

            <!-- Các lựa chọn trả lời -->
            <div id="choices-container" class="grid grid-cols-2 gap-4">
                <button class="choice-btn btn-3d w-full bg-orange-400 text-white font-bold py-4 rounded-xl text-4xl"></button>
                <button class="choice-btn btn-3d w-full bg-pink-400 text-white font-bold py-4 rounded-xl text-4xl"></button>
                <button class="choice-btn btn-3d w-full bg-purple-400 text-white font-bold py-4 rounded-xl text-4xl"></button>
                <button class="choice-btn btn-3d w-full bg-teal-400 text-white font-bold py-4 rounded-xl text-4xl"></button>
            </div>
        </div>
    </div>
</div>

<script>
    // Các thành phần DOM
    const gameCard = document.getElementById('game-card');
    const menuGrid = document.getElementById('menu-grid');
    const gameTitle = document.getElementById('game-title');
    const problemTextEl = document.getElementById('problem-text');
    const correctScoreEl = document.getElementById('correct-score');
    const incorrectScoreEl = document.getElementById('incorrect-score');
    const questionCounterEl = document.getElementById('question-counter');
    const iconContainer = document.getElementById('icon-container');
    const mouth = document.getElementById('mouth');
    const choicesContainer = document.getElementById('choices-container');
    const choiceButtons = choicesContainer.querySelectorAll('.choice-btn');
    const backBtn = document.getElementById('back-btn');

    // Trạng thái game
    let selectedTable = 0;
    let correctAnswer;
    let correctScore = 0;
    let incorrectScore = 0;
    let questionCount = 0;
    let isChecking = false;
    
    // Âm thanh
    let synth;
    let audioStarted = false;

    // --- Khởi tạo và Logic chuyển màn hình ---
    function initializeAudio() {
        if (audioStarted) return;
        Tone.start();
        synth = new Tone.Synth().toDestination();
        audioStarted = true;
    }

    function showGameScreen() {
        gameCard.classList.add('is-flipped');
    }

    function showMenuScreen() {
        gameCard.classList.remove('is-flipped');
    }

    // --- Logic Menu ---
    function createMenu() {
        for (let i = 1; i <= 9; i++) {
            const button = document.createElement('button');
            button.className = 'menu-btn btn-3d w-full bg-amber-500 text-white font-bold py-4 rounded-xl text-4xl';
            button.textContent = i;
            button.dataset.table = i;
            button.addEventListener('click', startGame);
            menuGrid.appendChild(button);
        }
    }

    function startGame(event) {
        initializeAudio();
        selectedTable = parseInt(event.target.dataset.table, 10);
        
        // Reset điểm
        correctScore = 0;
        incorrectScore = 0;
        questionCount = 0;

        gameTitle.textContent = `Bảng nhân ${selectedTable}`;
        generateProblem();
        showGameScreen();
    }
    
    backBtn.addEventListener('click', showMenuScreen);

    // --- Logic Game ---
    function setIconFace(state) {
        iconContainer.style.transform = 'scale(1)';
        switch (state) {
            case 'happy': 
                iconContainer.style.transform = 'scale(1.1) rotate(10deg)';
                mouth.setAttribute('d', 'M 30 65 Q 50 90, 70 65');
                break;
            case 'sad': 
                iconContainer.style.transform = 'scale(0.9) rotate(-5deg)';
                mouth.setAttribute('d', 'M 35 80 Q 50 70, 65 80');
                break;
            default: 
                iconContainer.style.transform = 'scale(1) rotate(0deg)';
                mouth.setAttribute('d', 'M 35 70 Q 50 80, 65 70');
                break;
        }
    }

    function playCorrectSound() { 
        if (synth) { 
            const now = Tone.now();
            synth.triggerAttackRelease("C5", "8n", now);
            synth.triggerAttackRelease("E5", "8n", now + 0.1);
            synth.triggerAttackRelease("G5", "8n", now + 0.2);
        } 
    }
    function playIncorrectSound() { if (synth) synth.triggerAttackRelease("G2", "4n"); }

    function generateProblem() {
        questionCount++;
        updateScores();
        setIconFace('neutral');
        choiceButtons.forEach(btn => { btn.disabled = false; });

        let multiplier = Math.floor(Math.random() * 10) + 1; // 1 to 10
        correctAnswer = selectedTable * multiplier;
        problemTextEl.textContent = `${selectedTable} × ${multiplier} = ?`;

        const choices = new Set([correctAnswer]);
        while (choices.size < 4) {
            let offset = (Math.floor(Math.random() * 5) - 2) * selectedTable; // E.g., -2*table, -1*table, 0, 1*table, 2*table
            if (offset === 0) continue;
            let wrongAnswer = correctAnswer + offset;
            if (wrongAnswer >= 0) {
                choices.add(wrongAnswer);
            }
        }

        const shuffledChoices = Array.from(choices).sort(() => Math.random() - 0.5);
        choiceButtons.forEach((btn, index) => {
            btn.textContent = shuffledChoices[index];
        });
    }

    function updateScores() {
        correctScoreEl.textContent = correctScore;
        incorrectScoreEl.textContent = incorrectScore;
        questionCounterEl.textContent = questionCount;
    }

    function handleChoiceSelection(event) {
        if (isChecking) return;
        isChecking = true;
        choiceButtons.forEach(btn => { btn.disabled = true; });

        const selectedAnswer = parseInt(event.target.textContent, 10);
        
        if (selectedAnswer === correctAnswer) {
            correctScore++;
            playCorrectSound();
            setIconFace('happy');
        } else {
            incorrectScore++;
            playIncorrectSound();
            setIconFace('sad');
        }
        updateScores();

        setTimeout(() => {
            generateProblem();
            isChecking = false;
        }, 1500);
    }
    
    choiceButtons.forEach(btn => {
        btn.addEventListener('click', handleChoiceSelection);
    });

    // Khởi tạo
    window.onload = createMenu;
</script>
</body>
</html>