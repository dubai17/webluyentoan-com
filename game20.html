<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Cộng Trừ Trong Phạm Vi 20</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Baloo 2', cursive;
            touch-action: manipulation;
            background: #f3e8ff; /* bg-violet-100 */
        }
        .game-card {
            box-shadow: 0 10px 20px rgba(93, 29, 151, 0.15), 0 6px 6px rgba(93, 29, 151, 0.15);
            border: 4px solid #fff;
            transform: rotate(1deg);
            transition: transform 0.2s ease;
        }
        .game-card:hover {
             transform: rotate(0deg);
        }
        .icon-face {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .choice-btn {
             box-shadow: 0 5px 0 rgba(0,0,0,0.2);
             transition: all 0.1s ease-in-out;
        }
        .choice-btn:active {
            transform: translateY(5px);
            box-shadow: 0 0px 0 rgba(0,0,0,0.2);
        }
        .choice-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm mx-auto bg-violet-400 rounded-2xl p-6 text-center text-white game-card">
        <h1 class="text-4xl font-bold mb-4" style="text-shadow: 2px 2px 0px rgba(0,0,0,0.1);">Vui Học Cộng Trừ</h1>

        <!-- Bảng điểm -->
        <div class="flex justify-around items-center bg-white/30 rounded-lg p-2 mb-6">
            <div>
                <span class="text-4xl font-bold text-green-300" id="correct-score">0</span>
                <p class="text-sm font-semibold">Đúng</p>
            </div>
             <div>
                <span class="text-4xl font-bold" id="question-counter">1</span>
                <p class="text-sm font-semibold">Câu</p>
            </div>
            <div>
                <span class="text-4xl font-bold text-red-300" id="incorrect-score">0</span>
                <p class="text-sm font-semibold">Sai</p>
            </div>
        </div>

        <!-- Icon hoạt hình -->
        <div class="my-6 h-28 flex items-center justify-center">
             <div id="icon-container" class="icon-face">
                <svg class="w-28 h-28" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#FFD15C" stroke="#E6A500" stroke-width="4"/>
                    <circle cx="35" cy="45" r="8" fill="white"/>
                    <circle cx="35" cy="45" r="4" fill="black"/>
                    <circle cx="65" cy="45" r="8" fill="white"/>
                    <circle cx="65" cy="45" r="4" fill="black"/>
                    <path id="mouth" d="M 35 70 Q 50 80, 65 70" stroke="black" stroke-width="4" fill="none" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        
        <!-- Phép toán -->
        <div class="mb-8 text-center">
            <div id="problem-text" class="text-6xl text-gray-800 font-bold bg-white rounded-lg p-4 shadow-inner mb-6">12 + 5 = ?</div>
        </div>

        <!-- Các lựa chọn trả lời -->
        <div id="choices-container" class="grid grid-cols-2 gap-4">
             <button class="choice-btn w-full bg-pink-500 text-white font-bold py-4 rounded-xl text-4xl"></button>
             <button class="choice-btn w-full bg-sky-500 text-white font-bold py-4 rounded-xl text-4xl"></button>
             <button class="choice-btn w-full bg-lime-500 text-white font-bold py-4 rounded-xl text-4xl"></button>
             <button class="choice-btn w-full bg-orange-500 text-white font-bold py-4 rounded-xl text-4xl"></button>
        </div>
    </div>

    <script>
        // Các thành phần DOM
        const problemTextEl = document.getElementById('problem-text');
        const correctScoreEl = document.getElementById('correct-score');
        const incorrectScoreEl = document.getElementById('incorrect-score');
        const questionCounterEl = document.getElementById('question-counter');
        const iconContainer = document.getElementById('icon-container');
        const mouth = document.getElementById('mouth');
        const choicesContainer = document.getElementById('choices-container');
        const choiceButtons = choicesContainer.querySelectorAll('.choice-btn');

        // Trạng thái game
        let correctAnswer;
        let correctScore = 0;
        let incorrectScore = 0;
        let questionCount = 0;
        let isChecking = false;
        
        // Âm thanh
        let synth;
        let audioStarted = false;

        function initializeAudio() {
            if (audioStarted) return;
            // Bắt đầu context âm thanh sau tương tác của người dùng
            Tone.start();
            synth = new Tone.Synth().toDestination();
            audioStarted = true;
        }

        // Thay đổi biểu cảm
        function setIconFace(state) {
            iconContainer.style.transform = 'scale(1)';
            switch (state) {
                case 'happy': 
                    iconContainer.style.transform = 'scale(1.1) rotate(10deg)';
                    mouth.setAttribute('d', 'M 30 65 Q 50 90, 70 65');
                    break;
                case 'sad': 
                    iconContainer.style.transform = 'scale(0.9) rotate(-5deg)';
                    mouth.setAttribute('d', 'M 35 80 Q 50 70, 65 80');
                    break;
                default: 
                    iconContainer.style.transform = 'scale(1) rotate(0deg)';
                    mouth.setAttribute('d', 'M 35 70 Q 50 80, 65 70');
                    break;
            }
        }

        // Phát âm thanh
        function playCorrectSound() { 
            if (!audioStarted) initializeAudio();
            if (synth) { 
                const now = Tone.now();
                synth.triggerAttackRelease("C5", "8n", now);
                synth.triggerAttackRelease("E5", "8n", now + 0.1);
                synth.triggerAttackRelease("G5", "8n", now + 0.2);
            } 
        }
        function playIncorrectSound() { 
            if (!audioStarted) initializeAudio();
            if (synth) synth.triggerAttackRelease("G2", "4n"); 
        }

        // Tạo bài toán mới
        function generateProblem() {
            questionCount++;
            updateScores();
            setIconFace('neutral');
            choiceButtons.forEach(btn => { btn.disabled = false; });

            const isAddition = Math.random() > 0.5;
            let numA, numB;

            if (isAddition) {
                // Phép cộng: tổng <= 20
                numA = Math.floor(Math.random() * 21);
                numB = Math.floor(Math.random() * (21 - numA));
                correctAnswer = numA + numB;
                problemTextEl.textContent = `${numA} + ${numB} = ?`;
            } else {
                // Phép trừ: kết quả >= 0
                numA = Math.floor(Math.random() * 21);
                numB = Math.floor(Math.random() * (numA + 1));
                correctAnswer = numA - numB;
                problemTextEl.textContent = `${numA} - ${numB} = ?`;
            }

            // Tạo các lựa chọn
            const choices = new Set([correctAnswer]);
            while (choices.size < 4) {
                let wrongAnswer = correctAnswer + (Math.floor(Math.random() * 7) - 3);
                if (wrongAnswer >= 0 && wrongAnswer <= 20) {
                    choices.add(wrongAnswer);
                }
            }

            // Xáo trộn và hiển thị lựa chọn
            const shuffledChoices = Array.from(choices).sort(() => Math.random() - 0.5);
            choiceButtons.forEach((btn, index) => {
                btn.textContent = shuffledChoices[index];
            });
        }

        // Cập nhật điểm
        function updateScores() {
            correctScoreEl.textContent = correctScore;
            incorrectScoreEl.textContent = incorrectScore;
            questionCounterEl.textContent = questionCount;
        }

        // Xử lý khi chọn câu trả lời
        function handleChoiceSelection(event) {
            initializeAudio(); // Đảm bảo âm thanh được khởi tạo
            if (isChecking) return;
            isChecking = true;
            
            choiceButtons.forEach(btn => { btn.disabled = true; });

            const selectedAnswer = parseInt(event.target.textContent, 10);
            
            if (selectedAnswer === correctAnswer) {
                correctScore++;
                playCorrectSound();
                setIconFace('happy');
            } else {
                incorrectScore++;
                playIncorrectSound();
                setIconFace('sad');
            }
            updateScores();

            // Tự động chuyển câu hỏi sau 1.5 giây
            setTimeout(() => {
                generateProblem();
                isChecking = false;
            }, 1500);
        }
        
        choiceButtons.forEach(btn => {
            btn.addEventListener('click', handleChoiceSelection);
        });

        // Bắt đầu game
        window.onload = generateProblem;
    </script>
</body>
</html>